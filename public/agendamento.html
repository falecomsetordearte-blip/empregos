<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Entrevista - VISIVA</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* CSS Inline para o Agendamento */
        .header-agendamento { text-align: center; margin-bottom: 30px; }
        .step-container { margin-bottom: 30px; }
        .step-title { font-size: 1.2em; color: #555; margin-bottom: 10px; font-weight: bold; }
        
        /* Grid de botões */
        .dates-grid, .times-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; 
            justify-content: center;
        }

        .option-btn {
            padding: 15px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .option-btn:hover { border-color: #007bff; color: #007bff; transform: translateY(-2px); }
        
        /* Selecionado */
        .option-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }

        /* Indisponível/Ocupado */
        .option-btn.disabled {
            background-color: #f8f9fa;
            color: #ccc;
            border-color: #eee;
            cursor: not-allowed;
            text-decoration: line-through;
            pointer-events: none; /* Impede clique */
        }

        /* Formulário */
        #formArea { display: none; background: #fff; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-top: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        #resumoSelection { background: #eef2f7; color: #333; padding: 12px; margin-bottom: 20px; border-radius: 6px; font-weight: bold; text-align: center; border-left: 5px solid #007bff; }
        
        .hidden { display: none; }
        .error { color: #dc3545; font-size: 0.9em; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-agendamento">
            <h1>Agendamento VISIVA</h1>
            <p>Selecione o horário para sua entrevista.</p>
        </div>

        <!-- Passo 1: Dia (Fixo) -->
        <div class="step-container">
            <div class="step-title">1. Dia Disponível</div>
            <div id="datasContainer" class="dates-grid">
                <!-- Gerado via JS -->
            </div>
        </div>

        <!-- Passo 2: Horários -->
        <div id="horariosStep" class="step-container hidden">
            <div class="step-title">2. Escolha o Horário</div>
            <div id="horariosContainer" class="times-grid">
                <!-- Gerado via JS -->
            </div>
            <p id="msgSemHorario" class="error hidden">Todos os horários deste dia já foram preenchidos.</p>
        </div>

        <!-- Passo 3: Cadastro -->
        <div id="formArea">
            <div class="step-title">3. Confirmação</div>
            <div id="resumoSelection"></div>
            
            <form id="bookingForm" class="form-container">
                <input type="text" id="nome" placeholder="Seu Nome Completo" required>
                <input type="text" id="whatsapp" placeholder="WhatsApp (DDD + Número)" required>
                <button type="submit" id="btnConfirmar">Confirmar Agendamento</button>
            </form>
            <p id="feedbackMessage"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO MANUAL DA AGENDA ---
        // Edite aqui para adicionar mais dias ou horários no futuro
        const CONFIG_AGENDA = [
            {
                data: '2025-02-02', // Formato YYYY-MM-DD
                label: '02/02 - HOJE',
                horarios: ['18:00', '18:20', '18:40', '19:00']
            }
        ];

        // --- VARIÁVEIS DE CONTROLE ---
        let dataSelecionada = null; 
        let horarioSelecionado = null;
        let agendamentosOcupados = []; // Lista do que vem do banco

        const datasContainer = document.getElementById('datasContainer');
        const horariosContainer = document.getElementById('horariosContainer');
        const horariosStep = document.getElementById('horariosStep');
        const formArea = document.getElementById('formArea');
        const feedbackMessage = document.getElementById('feedbackMessage');

        // --- INICIALIZAÇÃO ---
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarOcupados();
            gerarBotoesDias();
        });

        // 1. Busca agendamentos feitos no banco
        async function carregarOcupados() {
            try {
                const res = await fetch('/api/agendamentos');
                const dados = await res.json();
                // Guardamos as strings ISO originais para comparação
                agendamentosOcupados = dados;
            } catch (error) {
                console.error("Erro ao carregar agenda:", error);
            }
        }

        // 2. Cria o botão do dia fixo
        function gerarBotoesDias() {
            datasContainer.innerHTML = '';

            CONFIG_AGENDA.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = item.label;
                btn.onclick = () => selecionarDia(btn, item);
                datasContainer.appendChild(btn);
            });
        }

        // 3. Ao clicar no Dia
        function selecionarDia(elementoBtn, configItem) {
            // Estilo visual
            document.querySelectorAll('#datasContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');

            dataSelecionada = configItem.data;
            horarioSelecionado = null;
            formArea.style.display = 'none';
            
            gerarBotoesHorarios(configItem.horarios);
        }

        // 4. Gera os horários verificando se já existe no banco
        function gerarBotoesHorarios(listaHorarios) {
            horariosStep.classList.remove('hidden');
            horariosContainer.innerHTML = '';
            let temDisponivel = false;

            listaHorarios.forEach(hora => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = hora;

                // Lógica de Bloqueio:
                // Criamos a string ISO "falsa" (UTC) para comparar com o banco
                // Formato: YYYY-MM-DDTHH:mm:00.000Z
                const idParaChecar = `${dataSelecionada}T${hora}:00.000Z`;

                // Verifica se essa string exata existe no banco
                const estaOcupado = agendamentosOcupados.includes(idParaChecar);

                if (estaOcupado) {
                    btn.classList.add('disabled');
                    btn.title = "Já reservado";
                } else {
                    temDisponivel = true;
                    btn.onclick = () => selecionarHorario(btn, hora);
                }

                horariosContainer.appendChild(btn);
            });

            const msgErro = document.getElementById('msgSemHorario');
            if(!temDisponivel) msgErro.classList.remove('hidden');
            else msgErro.classList.add('hidden');
        }

        // 5. Ao clicar no Horário
        function selecionarHorario(elementoBtn, hora) {
            document.querySelectorAll('#horariosContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');

            horarioSelecionado = hora;
            formArea.style.display = 'block';

            // Texto de resumo
            const [ano, mes, dia] = dataSelecionada.split('-');
            document.getElementById('resumoSelection').innerText = 
                `Agendando para: ${dia}/${mes} às ${hora}`;
            
            // Rola a tela para o formulário (útil no celular)
            setTimeout(() => {
                formArea.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // 6. Envio do Formulário
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnConfirmar');
            const nome = document.getElementById('nome').value;
            const whatsapp = document.getElementById('whatsapp').value;

            btn.disabled = true;
            btn.textContent = "Processando...";
            feedbackMessage.className = "";
            feedbackMessage.textContent = "";

            // Monta a data final para salvar
            const dataHoraFinal = `${dataSelecionada}T${horarioSelecionado}:00.000Z`;

            try {
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome, 
                        whatsapp,
                        data_hora: dataHoraFinal
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    formArea.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="color: #28a745;">Agendamento Confirmado!</h2>
                            <p style="font-size: 1.1em; margin-top: 10px;">
                                Parabéns, <strong>${nome}</strong>.
                            </p>
                            <p>Sua entrevista foi marcada para <strong>${dataSelecionada.split('-').reverse().join('/')} às ${horarioSelecionado}</strong>.</p>
                            <button onclick="window.location.reload()" style="margin-top:20px; padding: 10px 20px; cursor:pointer;">Voltar</button>
                        </div>
                    `;
                    // Rola para o topo para ver a mensagem
                    formArea.scrollIntoView({ behavior: 'smooth' });
                } else {
                    feedbackMessage.className = "error";
                    feedbackMessage.textContent = result.error || "Erro ao agendar.";
                    btn.disabled = false;
                    btn.textContent = "Tentar Novamente";
                    
                    // Se deu conflito (alguém pegou na frente), atualiza a tela
                    if (response.status === 409) {
                        alert("Ops! Alguém acabou de reservar esse horário. A página será atualizada.");
                        window.location.reload();
                    }
                }
            } catch (erro) {
                console.error(erro);
                feedbackMessage.className = "error";
                feedbackMessage.textContent = "Erro de conexão. Verifique sua internet.";
                btn.disabled = false;
                btn.textContent = "Confirmar Agendamento";
            }
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento - Atendente Comercial</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        /* --- Estilos do Cabe√ßalho da Vaga --- */
        .header-agendamento { text-align: center; margin-bottom: 25px; }
        
        .header-agendamento h1 {
            color: #2c3e50;
            font-size: 1.4rem;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .job-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: left;
            font-size: 0.95rem;
            color: #444;
            line-height: 1.6;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        }

        .job-card strong { color: #333; font-weight: 600; }
        .job-card div { margin-bottom: 6px; }
        .job-card div:last-child { margin-bottom: 0; }
        
        .instruction-text {
            color: #007bff;
            font-weight: bold;
            font-size: 1.05rem;
            margin-top: 15px;
        }

        /* --- Estilos do Agendamento --- */
        .step-container { margin-bottom: 30px; }
        .step-title { font-size: 1.1em; color: #555; margin-bottom: 10px; font-weight: bold; }
        
        .dates-grid, .times-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); 
            gap: 10px; 
            justify-content: center;
        }

        .option-btn {
            padding: 12px 5px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 0.95rem;
            color: #333;
            font-weight: 500;
        }

        .option-btn:hover { border-color: #007bff; color: #007bff; transform: translateY(-2px); }
        
        .option-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }

        .option-btn.disabled {
            background-color: #e9ecef;
            color: #aaa;
            border-color: #eee;
            cursor: not-allowed;
            text-decoration: line-through;
            pointer-events: none;
            opacity: 0.8;
            font-size: 0.85em;
        }

        #formArea { display: none; background: #fff; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-top: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        #resumoSelection { background: #eef2f7; color: #333; padding: 12px; margin-bottom: 20px; border-radius: 6px; font-weight: bold; text-align: center; border-left: 5px solid #007bff; }
        
        .hidden { display: none; }
        .error { color: #dc3545; font-size: 0.9em; text-align: center; margin-top: 10px; }
        
        .time-separator {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 0.8em;
            color: #888;
            margin-top: 8px;
            margin-bottom: 4px;
            font-weight: bold;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div class="container">
        <!-- CABE√áALHO COM INFORMA√á√ïES DA VAGA -->
        <div class="header-agendamento">
            <h1>Entrevista: Atendente Comercial</h1>
            
            <div class="job-card">
                <div>üí∞ <strong>Sal√°rio:</strong> R$ 1.760,00 + VA R$ 500,00 + VT</div>
                <div>üìÖ <strong>Carga Hor√°ria Seg a Qui:</strong> 08h √†s 18h</div>
                <div>üìÖ <strong>E Sexta:</strong> 08h √†s 17h</div>
                <div>üçΩÔ∏è <strong>Intervalo:</strong> 11h √†s 12h</div>
            </div>

            <p class="instruction-text">Selecione um hor√°rio abaixo:</p>
        </div>

        <!-- Passo 1: Dia -->
        <div class="step-container">
            <div class="step-title">1. Data Dispon√≠vel</div>
            <div id="datasContainer" class="dates-grid"></div>
        </div>

        <!-- Passo 2: Hor√°rios -->
        <div id="horariosStep" class="step-container hidden">
            <div class="step-title">2. Escolha o Hor√°rio</div>
            <div id="horariosContainer" class="times-grid"></div>
            <p id="msgSemHorario" class="error hidden">Agenda lotada para este dia.</p>
        </div>

        <!-- Passo 3: Cadastro -->
        <div id="formArea">
            <div class="step-title">3. Confirma√ß√£o</div>
            <div id="resumoSelection"></div>
            
            <form id="bookingForm" class="form-container">
                <input type="text" id="nome" placeholder="Seu Nome Completo" required>
                <input type="text" id="whatsapp" placeholder="WhatsApp (DDD + N√∫mero)" required>
                <button type="submit" id="btnConfirmar">Confirmar Agendamento</button>
            </form>
            <p id="feedbackMessage"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO DA AGENDA (03/02) ---
        const CONFIG_AGENDA = [
            {
                data: '2025-02-03',
                label: '03/02 (Hoje)',
                horarios: [
                    // Manh√£
                    '11:00', '11:15', '11:30', '11:45', '12:00',
                    // Noite
                    '18:00', '18:15', '18:30', '18:45', '19:00'
                ]
            }
        ];

        let dataSelecionada = null; 
        let horarioSelecionado = null;
        let agendamentosOcupados = [];

        const datasContainer = document.getElementById('datasContainer');
        const horariosContainer = document.getElementById('horariosContainer');
        const horariosStep = document.getElementById('horariosStep');
        const formArea = document.getElementById('formArea');
        const feedbackMessage = document.getElementById('feedbackMessage');

        // --- INICIALIZA√á√ÉO ---
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarOcupados();
            gerarBotoesDias();
        });

        // 1. Busca status do banco (No Cache)
        async function carregarOcupados() {
            try {
                const timestamp = Date.now();
                const res = await fetch(`/api/agendamentos?t=${timestamp}`, {
                    cache: "no-store", 
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (res.ok) {
                    agendamentosOcupados = await res.json();
                }
            } catch (error) {
                console.error("Erro ao carregar agenda:", error);
            }
        }

        // 2. Gera bot√£o do Dia
        function gerarBotoesDias() {
            datasContainer.innerHTML = '';
            CONFIG_AGENDA.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = item.label;
                btn.onclick = () => selecionarDia(btn, item);
                datasContainer.appendChild(btn);
            });
        }

        // 3. Ao selecionar Dia
        async function selecionarDia(elementoBtn, configItem) {
            await carregarOcupados();

            document.querySelectorAll('#datasContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');

            dataSelecionada = configItem.data;
            horarioSelecionado = null;
            formArea.style.display = 'none';
            
            gerarBotoesHorarios(configItem.horarios);
        }

        // 4. Gera bot√µes de Hor√°rio
        function gerarBotoesHorarios(listaHorarios) {
            horariosStep.classList.remove('hidden');
            horariosContainer.innerHTML = '';
            let temDisponivel = false;

            listaHorarios.forEach((hora, index) => {
                // Separador visual Manh√£/Noite
                if (index > 0) {
                    const horaAnterior = parseInt(listaHorarios[index-1].split(':')[0]);
                    const horaAtual = parseInt(hora.split(':')[0]);
                    if (horaAtual - horaAnterior > 2) {
                        const separator = document.createElement('div');
                        separator.className = 'time-separator';
                        separator.textContent = '‚Ä¢ Tarde / Noite ‚Ä¢';
                        horariosContainer.appendChild(separator);
                    }
                }

                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = hora;

                const idParaChecar = `${dataSelecionada}T${hora}:00.000Z`;
                const estaOcupado = agendamentosOcupados.includes(idParaChecar);

                if (estaOcupado) {
                    btn.classList.add('disabled');
                    btn.innerHTML = `${hora}<br><small>(Lotado)</small>`;
                    btn.title = "Hor√°rio indispon√≠vel";
                } else {
                    temDisponivel = true;
                    btn.onclick = () => selecionarHorario(btn, hora);
                }

                horariosContainer.appendChild(btn);
            });

            const msgErro = document.getElementById('msgSemHorario');
            if(!temDisponivel) msgErro.classList.remove('hidden');
            else msgErro.classList.add('hidden');
        }

        // 5. Selecionar Hor√°rio
        function selecionarHorario(elementoBtn, hora) {
            document.querySelectorAll('#horariosContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');
            horarioSelecionado = hora;
            formArea.style.display = 'block';
            
            const [ano, mes, dia] = dataSelecionada.split('-');
            document.getElementById('resumoSelection').innerText = `Entrevista: ${dia}/${mes} √†s ${hora}`;
            
            setTimeout(() => formArea.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        // 6. Enviar
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnConfirmar');
            const nome = document.getElementById('nome').value;
            const whatsapp = document.getElementById('whatsapp').value;

            btn.disabled = true;
            btn.textContent = "Confirmando...";
            feedbackMessage.className = "";
            feedbackMessage.textContent = "";

            const dataHoraFinal = `${dataSelecionada}T${horarioSelecionado}:00.000Z`;

            try {
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome, 
                        whatsapp,
                        data_hora: dataHoraFinal
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    formArea.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="color: #28a745;">Agendamento Confirmado!</h2>
                            <p style="margin-top:15px">Ol√°, <strong>${nome}</strong>.</p>
                            <p>Sua entrevista est√° confirmada para hoje √†s <strong>${horarioSelecionado}</strong>.</p>
                            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
                            <p style="font-size: 0.9em; color: #555;">Por favor, chegue com 5 minutos de anteced√™ncia.</p>
                            <button onclick="window.location.reload()" style="margin-top:20px; padding: 10px 20px; cursor:pointer;">Voltar</button>
                        </div>
                    `;
                    formArea.scrollIntoView({ behavior: 'smooth' });
                } else {
                    if (response.status === 409) {
                        alert("Este hor√°rio acabou de ser preenchido por outra pessoa.");
                        window.location.reload();
                    } else {
                        throw new Error(result.error);
                    }
                }
            } catch (erro) {
                feedbackMessage.className = "error";
                feedbackMessage.textContent = "Erro: " + erro.message;
                btn.disabled = false;
                btn.textContent = "Tentar Novamente";
            }
        });
    </script>
</body>
</html>
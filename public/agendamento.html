<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendamento de Entrevista - VISIVA</title>
    <link rel="stylesheet" href="style.css">
    
    <style>
        .header-agendamento { text-align: center; margin-bottom: 30px; }
        .step-container { margin-bottom: 30px; }
        .step-title { font-size: 1.2em; color: #555; margin-bottom: 10px; font-weight: bold; }
        
        .dates-grid, .times-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); 
            gap: 12px; 
            justify-content: center;
        }

        .option-btn {
            padding: 15px;
            background-color: white;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
            font-size: 1rem;
            color: #333;
            font-weight: 500;
        }

        .option-btn:hover { border-color: #007bff; color: #007bff; transform: translateY(-2px); }
        
        .option-btn.selected {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
            box-shadow: 0 4px 10px rgba(0,123,255,0.3);
        }

        /* Estilo visual forte para Indisponível */
        .option-btn.disabled {
            background-color: #e9ecef; /* Cinza mais escuro */
            color: #999;
            border-color: #dee2e6;
            cursor: not-allowed;
            text-decoration: line-through;
            pointer-events: none;
            opacity: 0.7;
        }

        #formArea { display: none; background: #fff; padding: 25px; border-radius: 8px; border: 1px solid #ddd; margin-top: 20px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); }
        #resumoSelection { background: #eef2f7; color: #333; padding: 12px; margin-bottom: 20px; border-radius: 6px; font-weight: bold; text-align: center; border-left: 5px solid #007bff; }
        
        .hidden { display: none; }
        .error { color: #dc3545; font-size: 0.9em; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="container">
        <div class="header-agendamento">
            <h1>Agendamento VISIVA</h1>
            <p>Selecione o horário para sua entrevista.</p>
        </div>

        <!-- Passo 1: Dia (Fixo) -->
        <div class="step-container">
            <div class="step-title">1. Dia Disponível</div>
            <div id="datasContainer" class="dates-grid"></div>
        </div>

        <!-- Passo 2: Horários -->
        <div id="horariosStep" class="step-container hidden">
            <div class="step-title">2. Escolha o Horário</div>
            <div id="horariosContainer" class="times-grid"></div>
            <p id="msgSemHorario" class="error hidden">Todos os horários deste dia já foram preenchidos.</p>
        </div>

        <!-- Passo 3: Cadastro -->
        <div id="formArea">
            <div class="step-title">3. Confirmação</div>
            <div id="resumoSelection"></div>
            
            <form id="bookingForm" class="form-container">
                <input type="text" id="nome" placeholder="Seu Nome Completo" required>
                <input type="text" id="whatsapp" placeholder="WhatsApp (DDD + Número)" required>
                <button type="submit" id="btnConfirmar">Confirmar Agendamento</button>
            </form>
            <p id="feedbackMessage"></p>
        </div>
    </div>

    <script>
        // --- CONFIGURAÇÃO MANUAL ---
        const CONFIG_AGENDA = [
            {
                data: '2025-02-02',
                label: '02/02 (Hoje)',
                horarios: ['18:00', '18:20', '18:40', '19:00']
            }
        ];

        let dataSelecionada = null; 
        let horarioSelecionado = null;
        let agendamentosOcupados = [];

        const datasContainer = document.getElementById('datasContainer');
        const horariosContainer = document.getElementById('horariosContainer');
        const horariosStep = document.getElementById('horariosStep');
        const formArea = document.getElementById('formArea');
        const feedbackMessage = document.getElementById('feedbackMessage');

        // --- INICIALIZAÇÃO ---
        window.addEventListener('DOMContentLoaded', async () => {
            await carregarOcupados();
            gerarBotoesDias();
        });

        // 1. Busca status do banco (COM CACHE BUSTING)
        async function carregarOcupados() {
            try {
                // Adicionamos ?t=Date.now() para forçar o navegador a não usar cache
                const timestamp = Date.now();
                const res = await fetch(`/api/agendamentos?t=${timestamp}`, {
                    cache: "no-store", 
                    headers: { 'Cache-Control': 'no-cache' }
                });
                
                if (res.ok) {
                    agendamentosOcupados = await res.json();
                    console.log("Horários ocupados atualizados:", agendamentosOcupados);
                }
            } catch (error) {
                console.error("Erro ao carregar agenda:", error);
            }
        }

        // 2. Gera botões de dia
        function gerarBotoesDias() {
            datasContainer.innerHTML = '';
            CONFIG_AGENDA.forEach(item => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = item.label;
                btn.onclick = () => selecionarDia(btn, item);
                datasContainer.appendChild(btn);
            });
        }

        // 3. Ao selecionar Dia
        async function selecionarDia(elementoBtn, configItem) {
            // Recarrega ocupados antes de mostrar os botões para ter certeza absoluta
            await carregarOcupados();

            document.querySelectorAll('#datasContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');

            dataSelecionada = configItem.data;
            horarioSelecionado = null;
            formArea.style.display = 'none';
            
            gerarBotoesHorarios(configItem.horarios);
        }

        // 4. Gera botões de Horário
        function gerarBotoesHorarios(listaHorarios) {
            horariosStep.classList.remove('hidden');
            horariosContainer.innerHTML = '';
            let temDisponivel = false;

            listaHorarios.forEach(hora => {
                const btn = document.createElement('div');
                btn.className = 'option-btn';
                btn.textContent = hora;

                // Cria ID único UTC: 2025-02-02T18:00:00.000Z
                const idParaChecar = `${dataSelecionada}T${hora}:00.000Z`;
                
                // Verifica na lista atualizada
                const estaOcupado = agendamentosOcupados.includes(idParaChecar);

                if (estaOcupado) {
                    btn.classList.add('disabled');
                    btn.innerHTML = `${hora}<br><small>(Esgotado)</small>`;
                    btn.title = "Já reservado";
                } else {
                    temDisponivel = true;
                    btn.onclick = () => selecionarHorario(btn, hora);
                }

                horariosContainer.appendChild(btn);
            });

            if(!temDisponivel) {
                document.getElementById('msgSemHorario').classList.remove('hidden');
            } else {
                document.getElementById('msgSemHorario').classList.add('hidden');
            }
        }

        // 5. Selecionar Horário
        function selecionarHorario(elementoBtn, hora) {
            document.querySelectorAll('#horariosContainer .option-btn').forEach(b => b.classList.remove('selected'));
            elementoBtn.classList.add('selected');
            horarioSelecionado = hora;
            formArea.style.display = 'block';
            
            const [ano, mes, dia] = dataSelecionada.split('-');
            document.getElementById('resumoSelection').innerText = `Agendando para: ${dia}/${mes} às ${hora}`;
            
            setTimeout(() => formArea.scrollIntoView({ behavior: 'smooth' }), 100);
        }

        // 6. Enviar
        document.getElementById('bookingForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnConfirmar');
            const nome = document.getElementById('nome').value;
            const whatsapp = document.getElementById('whatsapp').value;

            btn.disabled = true;
            btn.textContent = "Verificando disponibilidade...";
            feedbackMessage.className = "";
            feedbackMessage.textContent = "";

            const dataHoraFinal = `${dataSelecionada}T${horarioSelecionado}:00.000Z`;

            try {
                const response = await fetch('/api/agendamentos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        nome, 
                        whatsapp,
                        data_hora: dataHoraFinal
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    formArea.innerHTML = `
                        <div style="text-align: center; padding: 20px;">
                            <h2 style="color: #28a745;">Agendamento Confirmado!</h2>
                            <p>Parabéns, <strong>${nome}</strong>.</p>
                            <p>Dia ${dataSelecionada.split('-').reverse().join('/')} às ${horarioSelecionado}.</p>
                            <button onclick="window.location.reload()" style="margin-top:20px; padding: 10px 20px; cursor:pointer;">Voltar</button>
                        </div>
                    `;
                    formArea.scrollIntoView({ behavior: 'smooth' });
                } else {
                    // Erro 409 = Conflict (Já existe)
                    if (response.status === 409) {
                        alert("Sinto muito! Outra pessoa acabou de confirmar este horário segundos antes de você.");
                        window.location.reload(); // Recarrega para mostrar o botão cinza
                    } else {
                        throw new Error(result.error || "Erro desconhecido");
                    }
                }
            } catch (erro) {
                console.error(erro);
                feedbackMessage.className = "error";
                feedbackMessage.textContent = "Erro ao agendar: " + erro.message;
                btn.disabled = false;
                btn.textContent = "Tentar Novamente";
            }
        });
    </script>
</body>
</html>